## SELECT 절의 처리 순서

SELECT 문의 처리 순서는 데이터베이스 시스템마다 약간의 차이가 있을 수 있지만, 일반적으로 다음과 같은 순서로 처리됩니다.

### SELECT 쿼리의 처리 순서

1. **FROM 절:** 쿼리의 대상이 되는 테이블을 지정합니다.
2. **ON 절:** 조인 조건을 명시합니다. (JOIN 절과 함께 사용)
3. **JOIN 절:** 여러 테이블을 연결합니다.
4. **WHERE 절:** 조건에 맞는 행을 필터링합니다.
5. **GROUP BY 절:** 특정 열을 기준으로 그룹을 생성합니다.
6. **HAVING 절:** 그룹에 대한 조건을 지정합니다.
7. **SELECT 절:** 최종적으로 조회할 열을 선택합니다.
8. **ORDER BY 절:** 결과를 정렬합니다.

### 각 절의 역할

* **FROM:** 쿼리의 시작점이 되는 테이블을 지정합니다.
* **ON, JOIN:** 여러 테이블을 연결하여 하나의 결과 집합을 만듭니다.
* **WHERE:** 조건에 맞는 행만 선택하여 결과 집합을 줄입니다.
* **GROUP BY:** 특정 열을 기준으로 데이터를 그룹화합니다.
* **HAVING:** 그룹화된 데이터에 대한 추가적인 조건을 지정합니다.
* **SELECT:** 최종적으로 출력할 열을 선택합니다.
* **ORDER BY:** 결과를 특정 열을 기준으로 정렬합니다.

### 예시를 통한 이해

```sql
SELECT customer_name, SUM(order_amount) AS total_purchase
FROM customers
JOIN orders ON customers.customer_id = orders.customer_id
WHERE country = 'USA'
GROUP BY customer_name
HAVING SUM(order_amount) > 1000
ORDER BY total_purchase DESC;
```

위 쿼리는 다음과 같은 순서로 처리됩니다.

1. `customers` 테이블과 `orders` 테이블을 `customer_id`를 기준으로 연결합니다.
2. `country`가 'USA'인 행만 선택합니다.
3. `customer_name`을 기준으로 그룹을 만들고, 각 그룹의 총 주문 금액을 계산합니다.
4. 총 주문 금액이 1000 이상인 그룹만 선택합니다.
5. `customer_name`과 총 주문 금액을 조회하고, 총 주문 금액을 기준으로 내림차순으로 정렬합니다.

### 왜 이 순서로 처리될까요?

* **데이터 필터링:** WHERE 절에서 조건에 맞는 데이터를 먼저 필터링하여 불필요한 계산을 줄입니다.
* **그룹화:** GROUP BY 절을 통해 데이터를 그룹화한 후, HAVING 절에서 그룹에 대한 조건을 적용합니다.
* **최종 선택:** SELECT 절에서 최종적으로 출력할 열을 선택합니다.

### 주의 사항

* **데이터베이스 시스템에 따른 차이:** 위에 설명된 순서는 일반적인 경우이며, 데이터베이스 시스템에 따라 약간의 차이가 있을 수 있습니다.
* **쿼리 최적화:** 데이터베이스는 쿼리를 실행하기 전에 최적화 과정을 거치기 때문에 실제 실행 순서는 약간 달라질 수 있습니다.

**SELECT 절의 처리 순서를 이해하면** 더 효율적인 SQL 쿼리를 작성하고 데이터베이스 성능을 향상시킬 수 있습니다. 

## SELECT FOR UPDATE 구문이란?

**SELECT FOR UPDATE** 구문은 데이터베이스에서 특정 행을 **잠금(lock)**하여 다른 트랜잭션이 해당 행을 수정하지 못하도록 하는 기능을 제공합니다. 쉽게 말해, "내가 이 데이터를 조회하는 동안 다른 사람이 이 데이터를 건드리지 못하게 해줘!"라고 데이터베이스에 요청하는 것입니다.

### 왜 SELECT FOR UPDATE를 사용할까요?

* **동시성 제어:** 여러 사용자가 동시에 데이터를 수정할 때 발생할 수 있는 데이터 불일치 문제를 방지합니다.
* **데이터 무결성 유지:** 특정 작업을 수행하는 동안 데이터가 변경되지 않도록 보장하여 데이터의 정확성을 유지합니다.

### 어떻게 사용하나요?

```sql
SELECT * FROM table_name WHERE condition FOR UPDATE;
```

* `table_name`: 잠금을 걸고 싶은 테이블 이름
* `condition`: 조건에 맞는 행을 선택

위와 같이 SELECT 문에 `FOR UPDATE` 키워드를 추가하면 해당 쿼리에 의해 선택된 행에 **배타적 잠금(exclusive lock)**이 걸립니다. 이렇게 잠긴 행은 다른 트랜잭션에서 수정하거나 삭제할 수 없게 됩니다.

### 예시

```sql
SELECT * FROM accounts WHERE account_id = 1 FOR UPDATE;
```

위 쿼리는 `accounts` 테이블에서 `account_id`가 1인 행을 선택하고, 해당 행에 잠금을 겁니다. 다른 트랜잭션이 이 계좌 정보를 수정하려고 하면 잠금이 해제될 때까지 기다리거나 오류가 발생합니다.

### 주의 사항

* **잠금 해제:** 트랜잭션이 COMMIT되거나 ROLLBACK되면 잠금이 해제됩니다.
* **데드락:** 여러 트랜잭션이 서로 다른 행에 잠금을 걸고 상대방의 잠금이 해제되기를 기다리는 상황이 발생할 수 있습니다. 이를 데드락이라고 하며, 데이터베이스 시스템은 데드락을 감지하고 해결해야 합니다.
* **성능:** SELECT FOR UPDATE는 성능에 영향을 줄 수 있으므로 필요한 경우에만 사용해야 합니다.

SELECT FOR UPDATE는 데이터의 동시성 제어에 필수적인 기능입니다. 특히, 은행 시스템처럼 데이터의 정확성이 중요한 시스템에서 많이 사용됩니다. 하지만 무분별하게 사용하면 성능 저하를 야기할 수 있으므로, 사용 목적에 맞게 적절히 활용해야 합니다.

* **추가적으로 알아두면 좋은 것:**
    * **FOR UPDATE NOWAIT:** 잠금을 획득하지 못하면 바로 에러 발생
    * **FOR UPDATE SKIP LOCKED:** 잠겨 있는 행은 건너뛰고 나머지 행만 처리
    * **트랜잭션 격리 수준**과의 연관성

**키워드:** SELECT FOR UPDATE, 데이터베이스, 잠금, 동시성 제어, 트랜잭션
