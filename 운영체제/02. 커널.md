## 정의
> 컴퓨터 운영 체제의 핵심이 되는 컴퓨터 프로그램으로, 전체 운영체제 프로그램 중 메모리에 로드된 부분만을 지칭한다.

운영체제 자체가 컴퓨터를 관리하기 위한 프로그램인 것은 맞지만, 실질적으로 컴퓨터 자원을 관리하는 프로그램 영역은 '커널'을 말한다. 그 외 나머지 부분은 필수적으로 필요하지는 않은 응용 유틸리티들이 있는데, 이들은 필요할 때만 호출되어 메모리에 로드되는 형식으로 동작한다. 응용 유틸리티까지 몽땅 메모리에 올려버리면 메모리는 그 큰 운영체제 사이즈를 받아들이기 굉장히 버겁기 때문에, 부트 로더가 로드 시에 '커널'에 해당하는 부위만 메모리에 로드한다.

운영체제가 설치된 모든 기기에는 커널이 있습니다. 커널은 마치 사람의 심장, 혹은 자동차의 엔진과도 같습니다. 어떤 커널을 사용하는지에 따라 우리가 실행하고 개발하는 프로그램이 하드웨어를 이용하는 양상이 달라지고, 결과적으로 컴퓨터 전체의 성능도 달라질 수 있습니다.

대부분의 운영체제 전공서는 운영체제의 핵심부, 즉 커널을 설명합니다. 따라서 앞으로 운영체제를 지칭할 때는 특별히 언급하지 않는 한 커널을 지칭한다고 봐도 무방합니다.

## 커널의 역할

![운영체제 구조](../이미지%20폴더/OpertationSystemStructure.png)

커널은 운영체제의 핵심 부분으로, 하드웨어와 소프트웨어 사이의 중개자 역할을 합니다. 

1. 프로세스 관리: 
   - CPU 스케줄링
   - 프로세스 생성, 종료, 일시 중지 등 관리

2. 메모리 관리:
   - 물리적/가상 메모리 할당 및 해제
   - 메모리 보호

3. 파일 시스템 관리:
   - 파일 생성, 읽기, 쓰기, 삭제 등 처리
   - 디렉토리 구조 관리

4. 장치 관리:
   - 하드웨어 장치와의 통신
   - 장치 드라이버 관리

5. 시스템 호출 인터페이스:
   - 응용 프로그램이 커널 기능을 사용할 수 있게 함

6. 보안 및 보호:
   - 시스템 자원에 대한 접근 제어
   - 사용자 권한 관리

커널은 운영체제의 안정성, 성능, 보안에 직접적인 영향을 미치는 중요한 요소입니다.

## 커널의 유형:

커널은 운영체제의 핵심 구성 요소로, 하드웨어와 소프트웨어 간의 상호작용을 관리합니다. 커널에는 여러 가지 유형이 있으며, 각 유형은 운영체제의 설계 철학과 성능 요구 사항에 따라 다르게 구현됩니다. 주요 커널 유형은 다음과 같습니다:

### 1. 모놀리딕 커널(Monolithic Kernel)
   - **구조**: 모놀리딕 커널은 하나의 큰 코드베이스로 이루어져 있으며, 모든 운영체제 기능이 커널 모드에서 실행됩니다. 여기에는 프로세스 관리, 메모리 관리, 파일 시스템, 장치 드라이버, 네트워킹 등이 포함됩니다.
   - **장점**: 커널 내부에서 모든 기능이 직접 호출되므로, 시스템 호출의 오버헤드가 적어 성능이 빠릅니다. 또한, 커널의 모든 기능이 하나의 공간에 있기 때문에 기능 간 통신이 효율적입니다.
   - **단점**: 커널 크기가 크고 복잡해지며, 하나의 모듈에서 문제가 발생하면 전체 시스템에 영향을 미칠 수 있습니다. 또한, 모듈 간의 결합이 강해 개발 및 유지보수가 어렵습니다.
   - **예**: 리눅스(Linux), 유닉스(Unix), MS-DOS.

### 2. 마이크로커널(Microkernel)
   - **구조**: 마이크로커널은 운영체제의 핵심 기능만 커널 모드에서 실행하고, 나머지 기능(예: 파일 시스템, 네트워킹, 장치 드라이버 등)은 사용자 모드에서 실행됩니다. 커널은 최소한의 기능(프로세스 관리, 메모리 관리, IPC 등)만 담당합니다.
   - **장점**: 시스템이 모듈화되어 있어 하나의 모듈에 문제가 생겨도 전체 시스템에 큰 영향을 주지 않습니다. 또한, 새로운 기능을 추가하거나 수정하기 쉽고, 운영체제를 여러 하드웨어 플랫폼에 이식하기 용이합니다.
   - **단점**: 사용자 모드와 커널 모드 간의 문맥 전환이 자주 발생하여 성능 저하가 생길 수 있습니다. 모놀리딕 커널에 비해 구현이 복잡할 수 있습니다.
   - **예**: QNX, Minix, L4, macOS(XNU 커널).

### 3. 하이브리드 커널(Hybrid Kernel)
   - **구조**: 하이브리드 커널은 모놀리딕 커널과 마이크로커널의 장점을 결합한 구조입니다. 기본적으로 마이크로커널의 설계 철학을 따르지만, 성능 향상을 위해 일부 운영체제 서비스(파일 시스템, 네트워킹 등)를 커널 모드에서 실행합니다.
   - **장점**: 모놀리딕 커널의 성능 이점을 어느 정도 유지하면서도, 마이크로커널의 안정성과 모듈성을 확보할 수 있습니다. 기능 간 통신이 효율적이며, 문제가 발생해도 시스템 전체에 영향을 미치는 것을 최소화할 수 있습니다.
   - **단점**: 설계와 구현이 복잡하며, 잘못된 구현은 두 가지 접근 방식의 단점을 모두 가질 수 있습니다.
   - **예**: Windows NT 계열(Windows 2000, XP, Vista, 7, 10 등), macOS(XNU 커널의 일부).

### 4. 엑소커널(Exokernel)
   - **구조**: 엑소커널은 기존 커널과 달리 하드웨어 자원에 대한 추상화를 최소화하고, 애플리케이션이 하드웨어 자원을 직접 관리하도록 허용하는 구조입니다. 커널은 최소한의 인터페이스만 제공하고, 나머지 모든 기능은 애플리케이션에서 처리합니다.
   - **장점**: 애플리케이션이 하드웨어 자원에 대한 직접적인 제어를 할 수 있어 성능이 최적화될 수 있습니다. 매우 가볍고 효율적이며, 다양한 애플리케이션에 맞춤형 자원 관리를 제공할 수 있습니다.
   - **단점**: 애플리케이션 개발이 복잡해지고, 개발자가 하드웨어 자원을 직접 관리해야 하므로 잘못된 관리가 성능 저하나 시스템 불안정을 초래할 수 있습니다.
   - **예**: MIT에서 개발된 연구용 엑소커널인 Aegis.

### 5. 나노커널(Nanokernel)
   - **구조**: 나노커널은 마이크로커널보다 더 작은 커널로, 하드웨어 초기화 및 단순한 자원 관리만 수행합니다. 대부분의 운영체제 기능은 나노커널 위에서 동작하는 모듈에 의해 처리됩니다.
   - **장점**: 매우 작은 코드베이스로 인해 보안성이 높고, 이식성이 뛰어납니다. 특정 하드웨어에 맞춤형 운영체제를 만들기 쉽습니다.
   - **단점**: 시스템 호출의 오버헤드가 크며, 성능이 낮을 수 있습니다. 구현이 매우 복잡합니다.
   - **예**: 연구 목적의 커널이나 특정 임베디드 시스템에 사용됩니다.

이러한 커널 유형들은 각기 다른 요구 사항과 환경에 맞춰 설계되었으며, 특정 커널 유형이 다른 것보다 항상 우월한 것은 아닙니다. 상황에 따라 적합한 커널 구조를 선택하는 것이 중요합니다.


## 커널의 동작 방식 - 이중모드 (Dual mode)

이중 모드는 CPU가 명령을 실행하는 모드를 두 가지로 구분한 것을 말한다. 유저모드와 커널모드 두 가지가 존재한다. 각 모드는 '슈퍼바이저 플래그'를 통해 구분한다. (1이면 커널모드, 0이면 유저모드)

커널모드(Kernel Mode)와 유저모드(User Mode)는 컴퓨터 시스템에서 프로그램이 실행되는 두 가지 다른 운영 모드입니다. 이들은 시스템 보안을 강화하고, 프로세스 간의 간섭을 방지하며, 자원의 효율적인 관리를 가능하게 하기 위해 설계된 개념입니다. 각 모드의 역할과 차이점은 다음과 같습니다.

### 커널모드(Kernel Mode)

- **설명**: 커널모드는 운영체제의 핵심 부분이 실행되는 모드로, 시스템의 모든 자원(예: 하드웨어 장치, 메모리, CPU 등)에 무제한 접근 권한을 갖습니다. 이 모드에서는 운영체제 커널과 관련된 중요한 코드와 드라이버가 실행됩니다.
  
- **특징**:
  - **전체 권한**: 커널모드에서 실행되는 프로그램은 하드웨어 자원 및 모든 메모리 공간에 접근할 수 있으며, 이를 통해 시스템의 기본적인 기능을 수행합니다.
  - **높은 위험성**: 커널모드에서의 오류는 시스템 전체에 영향을 미칠 수 있으며, 시스템이 불안정해지거나 충돌할 위험이 있습니다. 예를 들어, 잘못된 메모리 접근은 시스템 전체를 멈추게 할 수 있습니다.
  - **운영체제 및 드라이버**: 운영체제의 핵심 구성 요소, 장치 드라이버, 시스템 호출 처리 등이 이 모드에서 실행됩니다.

- **용도**: 커널모드는 운영체제의 중요한 작업을 수행하는 데 사용됩니다. 이는 프로세스 관리, 메모리 관리, 하드웨어 제어, 파일 시스템 접근 등 시스템의 핵심 기능을 포함합니다.

커널모드에서 실행되는 모든 코드는 동일한 Virtual Address Space를 공유한다. 그래서 커널모드에서는 프로세스의 구분없이 디바이스 드라이버나 시스템 스레드가 함께 공유되어 실행된다. 그러다 보니, 커널모드에서 드라이버가 실수로 잘못된 Vitual Address에 접근하여 데이터를 오염시키면 현재 실행 중인 운영체제가 손상될 수 있다.

### 유저모드(User Mode)

- **설명**: 유저모드는 응용 프로그램과 같은 일반적인 사용자 프로세스가 실행되는 모드로, 시스템 자원에 대한 제한된 접근 권한을 갖습니다. 이 모드에서는 시스템 리소스에 직접 접근할 수 없으며, 필요한 경우 운영체제의 커널을 통해 간접적으로 접근합니다.
  
- **특징**:
  - **제한된 권한**: 유저모드에서 실행되는 프로그램은 직접적으로 하드웨어 자원에 접근할 수 없으며, 메모리 공간 또한 자신에게 할당된 부분만 사용할 수 있습니다. 이를 통해 다른 프로세스나 커널을 보호합니다.
  - **안전성**: 유저모드에서 실행되는 프로그램의 오류는 해당 프로그램에만 영향을 미치며, 시스템 전체에 심각한 영향을 미치지 않습니다. 따라서 시스템 안정성을 유지하는 데 유리합니다.
  - **응용 프로그램**: 유저모드에서는 대부분의 응용 프로그램과 일부 시스템 서비스가 실행됩니다. 이들은 운영체제 커널의 서비스를 이용할 때 시스템 호출을 통해 커널모드로 전환됩니다.

- **용도**: 유저모드는 일반적인 응용 프로그램과 사용자 프로세스가 실행되는 환경입니다. 이 모드에서는 시스템의 핵심 자원에 대한 접근이 제한되어 있으며, 운영체제의 API를 통해 필요한 작업을 수행합니다.

### 커널모드와 유저모드 간의 전환

![이중모드 전환 이미지](../이미지%20폴더/dual%20mode.png)

- **시스템 호출(System Call)**: 유저모드의 응용 프로그램이 커널모드에서만 가능한 작업을 수행해야 할 때, 시스템 호출을 통해 커널모드로 전환합니다. 예를 들어, 파일을 열거나 데이터를 읽는 작업은 유저모드에서 커널모드로 전환이 필요합니다.

   [시스템 호출 내용정리](./세부%20개념/시스템콜.md)
  
- **인터럽트(Interrupt)**: 마이크로프로세서(CPU)가 프로그램을 실행하고 있을 때, 입출력하드웨어 등의 장치에 예외상황이 발생하여 처리가 필요할 경우에 마이크로프로세서에게 알려 처리할 수 있도록 유저모드에서 커널모드로 전환한다. 멀티 쓰레딩 환경에서 인터럽트에 의해 모드가 전환되는 상황을 만나기 쉽다.

   [인터럽트 내용정리](./세부%20개념/인터럽트.md)

- **문맥 전환(Context Switching)**: 프로세스가 유저모드에서 커널모드로 전환되거나, 그 반대로 전환될 때 문맥 전환이 발생합니다. 이 과정은 프로세스의 상태를 저장하고 복원하는 작업을 포함하며, 이로 인해 약간의 오버헤드가 발생할 수 있습니다.

### 커널모드와 유저모드의 비교

|   **특징**   |       **커널모드(Kernel Mode)**       |       **유저모드(User Mode)**       |
|:------------:|:------------------------------------:|:-----------------------------------:|
| **권한 수준**| 높은 권한 (모든 자원 접근 가능)      | 낮은 권한 (제한된 자원 접근)        |
| **오류의 영향**| 시스템 전체에 영향을 미침           | 개별 프로세스에만 영향을 미침        |
| **주요 실행 코드**| 운영체제 커널, 장치 드라이버      | 응용 프로그램, 사용자 프로세스      |
| **보안 및 안정성**| 보안 위험이 큼                   | 보안이 높음, 시스템 안정성 유지     |

이 두 모드는 시스템의 안정성과 보안을 강화하는 데 필수적인 역할을 합니다. 커널모드는 시스템의 핵심 기능을 담당하며, 유저모드는 사용자가 응용 프로그램을 안전하게 실행할 수 있도록 합니다.
